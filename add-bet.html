<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add New Bet - Parlay Tracker</title>
  
  <!-- Design System Stylesheets -->
  <link rel="stylesheet" href="design-system.css">
  <link rel="stylesheet" href="bottom-nav.css">
  <link rel="stylesheet" href="icons.css">
  
  <link rel="stylesheet" href="media/style.css">
  <!-- Roboto Font Import -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #121212;
      --surface: #252525;
      --primary: #140d52;
      --text: #e0e0e0;
      --text-secondary: #aaa;
      --border: #ffcc00a4;
      --green: #4caf50;
      --error: #f44336;
      --section-bg: #1a1a1a;
      --title-color: #e657ff;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Roboto, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      min-height: 100vh;
      padding: 15px;
      color: var(--text);
    }

    .form-container {
      max-width: 700px;
      margin: 0 auto;
      background: var(--surface);
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    .form-header {
      text-align: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
    }

    .form-header h1 {
      color: var(--title-color);
      font-size: 1.5em;
      margin-bottom: 5px;
    }

    .form-header p {
      color: var(--text-secondary);
      font-size: 0.85em;
    }

    .form-section {
      margin-bottom: 20px;
      padding: 15px;
      background: var(--section-bg);
      border-radius: 8px;
      border: 1px solid rgba(255, 204, 0, 0.2);
    }

    .form-section h2 {
      color: var(--title-color);
      font-size: 1.1em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      color: var(--text);
      margin-bottom: 6px;
      font-size: 0.9em;
    }

    .form-group label .required {
      color: var(--error);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 6px;
      font-size: 0.95em;
      transition: border-color 0.3s, background-color 0.3s;
      box-sizing: border-box;
      background: var(--bg);
      color: var(--text);
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--title-color);
      background: var(--surface);
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .leg-card {
      background: var(--surface);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 12px;
      border: 1px solid rgba(255, 204, 0, 0.3);
      position: relative;
    }

    .leg-card h3 {
      color: var(--title-color);
      font-size: 1em;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-weight: 600;
    }

    .remove-leg-btn {
      background: var(--error);
      color: white;
      border: none;
      border-radius: 6px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.8em;
      transition: opacity 0.3s, transform 0.1s;
    }

    .remove-leg-btn:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    .remove-leg-btn:active {
      transform: scale(0.95);
    }

    .add-leg-btn,
    .submit-btn,
    .cancel-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.95em;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.3s, transform 0.1s, box-shadow 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .add-leg-btn {
      background: var(--primary);
      color: white;
      width: 100%;
      justify-content: center;
    }

    .add-leg-btn:hover {
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(20, 13, 82, 0.4);
    }

    .add-leg-btn:active {
      transform: scale(0.98);
    }

    .submit-btn {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
      color: white;
      width: 100%;
      justify-content: center;
      margin-top: 15px;
    }

    .submit-btn:hover {
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(240, 147, 251, 0.4);
    }

    .submit-btn:active {
      transform: scale(0.98);
    }

    .cancel-btn {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text);
      width: 100%;
      justify-content: center;
      margin-top: 8px;
      border: 1px solid rgba(255, 204, 0, 0.3);
    }

    .cancel-btn:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .cancel-btn:active {
      transform: scale(0.98);
    }

    .help-text {
      font-size: 0.8em;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .stat-type-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-type-option {
      padding: 8px;
      background: var(--bg);
      border: 1px solid rgba(255, 204, 0, 0.3);
      border-radius: 6px;
      cursor: pointer;
      text-align: center;
      transition: all 0.3s;
      font-size: 0.9em;
      color: var(--text);
    }

    .stat-type-option:hover {
      border-color: var(--title-color);
      background: var(--surface);
    }

    .stat-type-option.selected {
      border-color: var(--title-color);
      background: var(--title-color);
      color: white;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      font-size: 0.9em;
    }

    .notification.success {
      background: var(--green);
    }

    .notification.error {
      background: var(--error);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }

      .form-container {
        padding: 15px;
      }

      .form-header h1 {
        font-size: 1.3em;
      }
    }

    /* Autocomplete styles */
    .autocomplete-items {
      position: absolute;
      border: 1px solid #ddd;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      background: #252525;
      max-height: 200px;
      overflow-y: auto;
      border-radius: 0 0 8px 8px;
    }

    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #252525;
      border-bottom: 1px solid #333;
      color: #e0e0e0;
    }

    .autocomplete-items div:hover {
      background-color: #333;
    }

    .autocomplete-active {
      background-color: #140d52 !important;
      color: #fff !important;
    }
  </style>
</head>
<body>
  <div class="form-container">
    <div class="form-header">
      <h1>Add New Bet</h1>
      <p>Create a new parlay or single bet to track</p>
    </div>

    <form id="add-bet-form">
      <!-- Bet Information Section -->
      <div class="form-section">
        <h2>Bet Information</h2>
        
        <div class="form-group">
          <label for="bet-name">Bet Name</label>
          <input type="text" id="bet-name" placeholder="Optional custom name (leave blank for auto-generated)">
          <div class="help-text">Optional: Give your bet a custom name, or leave blank for auto-generated name</div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="bet-type">Bet Type <span class="required">*</span></label>
            <select id="bet-type" required>
              <option value="">Select type...</option>
              <option value="parlay">Parlay</option>
              <option value="SGP">Same Game Parlay (SGP)</option>
              <option value="single">Single Bet</option>
              <option value="teaser">Teaser</option>
            </select>
          </div>

          <div class="form-group">
            <label for="betting-site">Betting Site <span class="required">*</span></label>
            <select id="betting-site" required>
              <option value="">Select site...</option>
              <option value="FanDuel">FanDuel</option>
              <option value="DraftKings">DraftKings</option>
              <option value="Bet365">Bet365</option>
              <option value="BetMGM">BetMGM</option>
              <option value="Caesars">Caesars</option>
              <option value="PointsBet">PointsBet</option>
              <option value="Dabble">Dabble</option>
              <option value="Other">Other</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="wager">Wager Amount <span class="required">*</span></label>
            <input type="number" id="wager" placeholder="25.00" step="0.01" min="0" required>
          </div>

          <div class="form-group">
            <label for="potential-payout">Potential Payout</label>
            <input type="number" id="potential-payout" placeholder="110.00" step="0.01" min="0">
            <div class="help-text">Auto-calculated from odds</div>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="odds">Odds <span class="required">*</span></label>
            <input type="text" id="odds" placeholder="+250 or -110" required>
            <div class="help-text">Format: +250 or -110</div>
          </div>

          <div class="form-group">
            <label for="bet-date">Bet Date <span class="required">*</span></label>
            <input type="date" id="bet-date" required>
          </div>
        </div>

        <div class="form-group">
          <label for="bet-id">Bet ID (Optional)</label>
          <input type="text" id="bet-id" placeholder="From betting slip">
          <div class="help-text">Optional: Copy from your betting site</div>
        </div>
      </div>
      
      <!-- Secondary Bettors Section -->
      <div class="form-section">
        <h2>üë• Secondary Bettors (Optional)</h2>
        <div class="form-group">
          <label for="bettor-search-manual">Add Co-Bettors</label>
          <input type="text" id="bettor-search-manual" placeholder="Type username or email to search..." autocomplete="off">
          <div id="bettor-suggestions-manual" style="display: none; background: var(--bg); border: 2px solid var(--primary); border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; margin-top: -8px;"></div>
          <div id="selected-bettors-manual" style="margin-top: 12px; display: flex; flex-wrap: wrap; gap: 8px;"></div>
          <div class="help-text">Search and add other users who are part of this bet</div>
        </div>
      </div>

      <!-- Legs Section -->
      <div class="form-section">
        <h2>Bet Legs</h2>
        <div id="legs-container"></div>
        <button type="button" class="add-leg-btn" id="add-leg-btn">
          + Add Leg
        </button>
      </div>

      <!-- Submit Section -->
      <button type="submit" class="submit-btn">
        Create Bet
      </button>
      <button type="button" class="cancel-btn" onclick="window.location.href='/'">
        Cancel
      </button>
    </form>
  </div>

  <script>
    let legCount = 0;

    // Sports and their common stats
    const sportStats = {
      'NFL': {
        'Player Props': [
          { value: 'passing_yards_alt', label: 'Passing Yards' },
          { value: 'rushing_yards_alt', label: 'Rushing Yards' },
          { value: 'receiving_yards_alt', label: 'Receiving Yards' },
          { value: 'touchdowns', label: 'Total Touchdowns' },
          { value: 'receptions', label: 'Receptions' },
          { value: 'pass_completions', label: 'Pass Completions' },
          { value: 'pass_attempts', label: 'Pass Attempts' },
          { value: 'interceptions', label: 'Interceptions' },
        ],
        'Team Props': [
          { value: 'spread', label: 'Spread' },
          { value: 'moneyline', label: 'Moneyline' },
          { value: 'total_points', label: 'Total Points O/U' },
        ]
      },
      'NBA': {
        'Player Props': [
          { value: 'points', label: 'Points' },
          { value: 'rebounds', label: 'Rebounds' },
          { value: 'assists', label: 'Assists' },
          { value: 'threes', label: '3-Pointers Made' },
          { value: 'steals', label: 'Steals' },
          { value: 'blocks', label: 'Blocks' },
          { value: 'pts_rebs_asts', label: 'PTS+REB+AST' },
        ],
        'Team Props': [
          { value: 'spread', label: 'Spread' },
          { value: 'moneyline', label: 'Moneyline' },
          { value: 'total_points', label: 'Total Points O/U' },
        ]
      },
      'MLB': {
        'Player Props': [
          { value: 'hits', label: 'Hits' },
          { value: 'runs', label: 'Runs' },
          { value: 'rbis', label: 'RBIs' },
          { value: 'strikeouts_pitcher', label: 'Strikeouts (Pitcher)' },
          { value: 'home_runs', label: 'Home Runs' },
        ],
        'Team Props': [
          { value: 'spread', label: 'Run Line' },
          { value: 'moneyline', label: 'Moneyline' },
          { value: 'total_runs', label: 'Total Runs O/U' },
        ]
      },
      'NHL': {
        'Player Props': [
          { value: 'goals', label: 'Goals' },
          { value: 'assists', label: 'Assists' },
          { value: 'points', label: 'Points' },
          { value: 'saves', label: 'Saves (Goalie)' },
          { value: 'shots', label: 'Shots on Goal' },
        ],
        'Team Props': [
          { value: 'spread', label: 'Puck Line' },
          { value: 'moneyline', label: 'Moneyline' },
          { value: 'total_goals', label: 'Total Goals O/U' },
        ]
      }
    };

    // Secondary bettors functionality
    let selectedSecondaryBettors = [];
    let allUsers = [];

    // Static data for autofill
    const autofillData = {
      teams: {
        NFL: [
          "Arizona Cardinals", "Atlanta Falcons", "Baltimore Ravens", "Buffalo Bills",
          "Carolina Panthers", "Chicago Bears", "Cincinnati Bengals", "Cleveland Browns",
          "Dallas Cowboys", "Denver Broncos", "Detroit Lions", "Green Bay Packers",
          "Houston Texans", "Indianapolis Colts", "Jacksonville Jaguars", "Kansas City Chiefs",
          "Las Vegas Raiders", "Los Angeles Chargers", "Los Angeles Rams", "Miami Dolphins",
          "Minnesota Vikings", "New England Patriots", "New Orleans Saints", "New York Giants",
          "New York Jets", "Philadelphia Eagles", "Pittsburgh Steelers", "San Francisco 49ers",
          "Seattle Seahawks", "Tampa Bay Buccaneers", "Tennessee Titans", "Washington Commanders"
        ],
        NBA: [
          "Atlanta Hawks", "Boston Celtics", "Brooklyn Nets", "Charlotte Hornets",
          "Chicago Bulls", "Cleveland Cavaliers", "Dallas Mavericks", "Denver Nuggets",
          "Detroit Pistons", "Golden State Warriors", "Houston Rockets", "Indiana Pacers",
          "LA Clippers", "Los Angeles Lakers", "Memphis Grizzlies", "Miami Heat",
          "Milwaukee Bucks", "Minnesota Timberwolves", "New Orleans Pelicans", "New York Knicks",
          "Oklahoma City Thunder", "Orlando Magic", "Philadelphia 76ers", "Phoenix Suns",
          "Portland Trail Blazers", "Sacramento Kings", "San Antonio Spurs", "Toronto Raptors",
          "Utah Jazz", "Washington Wizards"
        ],
        MLB: [
          "Arizona Diamondbacks", "Atlanta Braves", "Baltimore Orioles", "Boston Red Sox",
          "Chicago Cubs", "Chicago White Sox", "Cincinnati Reds", "Cleveland Guardians",
          "Colorado Rockies", "Detroit Tigers", "Houston Astros", "Kansas City Royals",
          "Los Angeles Angels", "Los Angeles Dodgers", "Miami Marlins", "Milwaukee Brewers",
          "Minnesota Twins", "New York Mets", "New York Yankees", "Oakland Athletics",
          "Philadelphia Phillies", "Pittsburgh Pirates", "San Diego Padres", "San Francisco Giants",
          "Seattle Mariners", "St. Louis Cardinals", "Tampa Bay Rays", "Texas Rangers",
          "Toronto Blue Jays", "Washington Nationals"
        ],
        NHL: [
          "Anaheim Ducks", "Arizona Coyotes", "Boston Bruins", "Buffalo Sabres",
          "Calgary Flames", "Carolina Hurricanes", "Chicago Blackhawks", "Colorado Avalanche",
          "Columbus Blue Jackets", "Dallas Stars", "Detroit Red Wings", "Edmonton Oilers",
          "Florida Panthers", "Los Angeles Kings", "Minnesota Wild", "Montreal Canadiens",
          "Nashville Predators", "New Jersey Devils", "New York Islanders", "New York Rangers",
          "Ottawa Senators", "Philadelphia Flyers", "Pittsburgh Penguins", "San Jose Sharks",
          "Seattle Kraken", "St. Louis Blues", "Tampa Bay Lightning", "Toronto Maple Leafs",
          "Vancouver Canucks", "Vegas Golden Knights", "Washington Capitals", "Winnipeg Jets"
        ]
      },
      players: {
        NFL: [
          "Patrick Mahomes", "Josh Allen", "Lamar Jackson", "Joe Burrow", "Justin Herbert",
          "Dak Prescott", "Jalen Hurts", "Deshaun Watson", "Matthew Stafford", "Tom Brady",
          "Christian McCaffrey", "Austin Ekeler", "Derrick Henry", "Nick Chubb", "Saquon Barkley",
          "Davante Adams", "Tyreek Hill", "Stefon Diggs", "DeAndre Hopkins", "Mike Evans",
          "Travis Kelce", "George Kittle", "Mark Andrews", "Dallas Goedert", "T.J. Hockenson"
        ],
        NBA: [
          "Stephen Curry", "LeBron James", "Kevin Durant", "Giannis Antetokounmpo", "Kawhi Leonard",
          "Luka Donƒçiƒá", "Nikola Jokiƒá", "Joel Embiid", "James Harden", "Russell Westbrook",
          "Kyrie Irving", "Damian Lillard", "Ja Morant", "Zion Williamson", "Victor Wembanyama",
          "Anthony Davis", "Donovan Mitchell", "Devin Booker", "Jayson Tatum", "Jaylen Brown"
        ]
      }
    };

    // SGP state management
    let sgpHomeTeam = '';
    let sgpAwayTeam = '';

    // Set today's date as default
    document.getElementById('bet-date').valueAsDate = new Date();

    // Handle bet type changes for SGP logic
    document.getElementById('bet-type').addEventListener('change', function() {
      const betType = this.value;
      const isSGP = betType === 'SGP';
      
      // Update all existing legs
      const legCards = document.querySelectorAll('.leg-card');
      legCards.forEach((legCard, index) => {
        updateLegForSGP(legCard, index, isSGP);
      });
    });

    // Auto-calculation functions
    function calculatePayoutFromOdds(wager, odds) {
      if (!wager || !odds || wager <= 0) return null;
      const oddsStr = odds.toString().trim();
      
      let profit = 0;
      if (oddsStr.startsWith('+')) {
        const oddsNum = parseInt(oddsStr.substring(1));
        profit = wager * (oddsNum / 100);
      } else if (oddsStr.startsWith('-')) {
        const oddsNum = parseInt(oddsStr.substring(1));
        profit = wager / (oddsNum / 100);
      } else {
        const oddsNum = parseInt(oddsStr);
        if (oddsNum > 0) {
          profit = wager * (oddsNum / 100);
        } else {
          profit = wager / (Math.abs(oddsNum) / 100);
        }
      }
      
      return Math.round((wager + profit) * 100) / 100;
    }

    function calculateOddsFromPayout(wager, payout) {
      if (!wager || !payout || wager <= 0) return null;
      const profit = payout - wager;
      if (profit <= 0) return null;
      
      if (profit >= wager) {
        return '+' + Math.round((profit / wager) * 100);
      } else {
        return '-' + Math.round((wager / profit) * 100);
      }
    }

    // Set up auto-calculation listeners
    const wagerInput = document.getElementById('wager');
    const oddsInput = document.getElementById('odds');
    const payoutInput = document.getElementById('potential-payout');

    wagerInput.addEventListener('input', () => {
      if (oddsInput.value && (!payoutInput.value || parseFloat(payoutInput.value) === 0)) {
        const payout = calculatePayoutFromOdds(parseFloat(wagerInput.value), oddsInput.value);
        if (payout) payoutInput.value = payout;
      }
    });

    oddsInput.addEventListener('input', () => {
      const w = parseFloat(wagerInput.value);
      const o = oddsInput.value.trim();
      if (w && o) {
        const p = calculatePayoutFromOdds(w, o);
        if (p) payoutInput.value = p;
      }
    });

    payoutInput.addEventListener('input', () => {
      const w = parseFloat(wagerInput.value);
      const p = parseFloat(payoutInput.value);
      if (w && p && p > w && !oddsInput.value) {
        const o = calculateOddsFromPayout(w, p);
        if (o) oddsInput.value = o;
      }
    });

    // Fetch users for autocomplete
    async function fetchAllUsers() {
      try {
        const response = await fetch('/api/users', {
          credentials: 'include'
        });
        if (response.ok) {
          const result = await response.json();
          allUsers = result.users || [];
        }
      } catch (error) {
        console.error('Failed to fetch users:', error);
      }
    }

    // Secondary bettors autocomplete
    const bettorSearchManual = document.getElementById('bettor-search-manual');
    const bettorSuggestionsManual = document.getElementById('bettor-suggestions-manual');
    const selectedBettorsManual = document.getElementById('selected-bettors-manual');

    bettorSearchManual.addEventListener('input', () => {
      const query = bettorSearchManual.value.toLowerCase().trim();
      
      if (query.length < 2) {
        bettorSuggestionsManual.style.display = 'none';
        return;
      }
      
      const matches = allUsers.filter(user => 
        user.username.toLowerCase().includes(query) || 
        user.email.toLowerCase().includes(query)
      ).filter(user => 
        !selectedSecondaryBettors.find(b => b.id === user.id)
      ).slice(0, 5);
      
      if (matches.length === 0) {
        bettorSuggestionsManual.style.display = 'none';
        return;
      }
      
      bettorSuggestionsManual.innerHTML = matches.map(user => `
        <div class="bettor-suggestion" data-user-id="${user.id}" data-username="${user.username}" style="padding: 10px; cursor: pointer; border-bottom: 1px solid rgba(255,204,0,0.2); transition: background 0.2s;">
          <div style="font-weight: 600; color: var(--text);">${user.username}</div>
          <div style="font-size: 12px; color: var(--text-secondary);">${user.email}</div>
        </div>
      `).join('');
      
      bettorSuggestionsManual.style.display = 'block';
      
      document.querySelectorAll('.bettor-suggestion').forEach(item => {
        item.addEventListener('mouseenter', () => item.style.background = 'rgba(255,204,0,0.1)');
        item.addEventListener('mouseleave', () => item.style.background = 'transparent');
        item.addEventListener('click', () => {
          const userId = parseInt(item.dataset.userId);
          const username = item.dataset.username;
          addSecondaryBettor(userId, username);
          bettorSearchManual.value = '';
          bettorSuggestionsManual.style.display = 'none';
        });
      });
    });

    function addSecondaryBettor(userId, username) {
      if (selectedSecondaryBettors.find(b => b.id === userId)) {
        return;
      }
      
      selectedSecondaryBettors.push({ id: userId, username });
      renderSelectedBettors();
    }

    function renderSelectedBettors() {
      if (selectedSecondaryBettors.length === 0) {
        selectedBettorsManual.innerHTML = '<p style="color: var(--text-secondary); font-size: 13px; font-style: italic;">No secondary bettors added</p>';
        return;
      }
      
      selectedBettorsManual.innerHTML = selectedSecondaryBettors.map(bettor => `
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 12px; border-radius: 20px; display: inline-flex; align-items: center; gap: 8px; font-size: 14px; font-weight: 500;">
          <span>${bettor.username}</span>
          <button class="remove-bettor" data-user-id="${bettor.id}" style="background: rgba(255,255,255,0.3); border: none; color: white; cursor: pointer; border-radius: 50%; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">√ó</button>
        </div>
      `).join('');
      
      document.querySelectorAll('.remove-bettor').forEach(btn => {
        btn.addEventListener('click', () => {
          const userId = parseInt(btn.dataset.userId);
          selectedSecondaryBettors = selectedSecondaryBettors.filter(b => b.id !== userId);
          renderSelectedBettors();
        });
      });
    }

    document.addEventListener('click', (e) => {
      if (!bettorSearchManual.contains(e.target) && !bettorSuggestionsManual.contains(e.target)) {
        bettorSuggestionsManual.style.display = 'none';
      }
    });

    // Fetch users on page load
    fetchAllUsers();
    renderSelectedBettors();

    function updateLegForSGP(legCard, legIndex, isSGP) {
      const awayInput = legCard.querySelector('.leg-away');
      const homeInput = legCard.querySelector('.leg-home');
      
      if (isSGP && legIndex > 0) { // Legs after the first one
        // Auto-populate from first leg's values
        awayInput.value = sgpAwayTeam;
        homeInput.value = sgpHomeTeam;
        
        // Disable the inputs for legs 2+
        awayInput.disabled = true;
        homeInput.disabled = true;
        
        // Add visual indicator
        awayInput.style.backgroundColor = '#333';
        homeInput.style.backgroundColor = '#333';
        awayInput.style.color = '#888';
        homeInput.style.color = '#888';
      } else {
        // Enable inputs for first leg or non-SGP bets
        awayInput.disabled = false;
        homeInput.disabled = false;
        
        // Reset styling
        awayInput.style.backgroundColor = '';
        homeInput.style.backgroundColor = '';
        awayInput.style.color = '';
        homeInput.style.color = '';
      }
    }

    function addLeg() {
      legCount++;
      const legCard = document.createElement('div');
      legCard.className = 'leg-card';
      legCard.id = `leg-${legCount}`;
      
      const betType = document.getElementById('bet-type').value;
      const isSGP = betType === 'SGP';
      const isFirstLeg = legCount === 1;
      
      legCard.innerHTML = `
        <h3>
          Leg ${legCount}
          <button type="button" class="remove-leg-btn" onclick="removeLeg(${legCount})">Remove</button>
        </h3>
        
        <div class="form-group">
          <label>Sport <span class="required">*</span></label>
          <select class="leg-sport" onchange="updateStatOptions(${legCount})" required>
            <option value="">Select sport...</option>
            <option value="NFL">NFL</option>
            <option value="NBA">NBA</option>
            <option value="MLB">MLB</option>
            <option value="NHL">NHL</option>
          </select>
        </div>

        <div class="form-group">
          <label>Bet Category <span class="required">*</span></label>
          <select class="leg-category" onchange="updateStatOptions(${legCount})" required>
            <option value="">Select category...</option>
            <option value="Player Props">Player Props</option>
            <option value="Team Props">Team Props</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Game Date <span class="required">*</span></label>
            <input type="date" class="leg-date" required>
          </div>

          <div class="form-group leg-player-group">
            <label class="leg-player-label">Player/Team Name <span class="required">*</span></label>
            <input type="text" class="leg-player" placeholder="e.g., Patrick Mahomes" required autocomplete="off" data-autofill="player">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Away Team <span class="required">*</span></label>
            <input type="text" class="leg-away" placeholder="e.g., Kansas City Chiefs" required autocomplete="off" data-autofill="team" ${isSGP && !isFirstLeg ? 'disabled' : ''}>
          </div>

          <div class="form-group">
            <label>Home Team <span class="required">*</span></label>
            <input type="text" class="leg-home" placeholder="e.g., Tampa Bay Buccaneers" required autocomplete="off" data-autofill="team" ${isSGP && !isFirstLeg ? 'disabled' : ''}>
          </div>
        </div>

        <div class="form-group">
          <label>Stat Type <span class="required">*</span></label>
          <select class="leg-stat" required>
            <option value="">Select stat...</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Over/Under <span class="required">*</span></label>
            <select class="leg-stat-add" required>
              <option value="over">Over</option>
              <option value="under">Under</option>
            </select>
          </div>

          <div class="form-group">
            <label>Target <span class="required">*</span></label>
            <input type="number" class="leg-target" placeholder="275.5" step="0.5" required>
          </div>
        </div>
      `;
      
      document.getElementById('legs-container').appendChild(legCard);
      
      // Set today's date as default
      const today = new Date().toISOString().split('T')[0];
      legCard.querySelector('.leg-date').value = today;
      
      // Apply SGP styling if needed
      if (isSGP && !isFirstLeg) {
        updateLegForSGP(legCard, legCount - 1, true);
      }
      
      // Add autofill functionality
      setupAutofill(legCard);
      
      // Add SGP listeners for first leg
      if (isSGP && isFirstLeg) {
        const awayInput = legCard.querySelector('.leg-away');
        const homeInput = legCard.querySelector('.leg-home');
        
        awayInput.addEventListener('input', updateSGPTeams);
        homeInput.addEventListener('input', updateSGPTeams);
      }
    }

    function updateSGPTeams() {
      // Update SGP team values from first leg
      const firstLeg = document.getElementById('leg-1');
      if (firstLeg) {
        const awayInput = firstLeg.querySelector('.leg-away');
        const homeInput = firstLeg.querySelector('.leg-home');
        
        sgpAwayTeam = awayInput.value;
        sgpHomeTeam = homeInput.value;
        
        // Update all other legs
        const betType = document.getElementById('bet-type').value;
        if (betType === 'SGP') {
          const legCards = document.querySelectorAll('.leg-card');
          legCards.forEach((legCard, index) => {
            if (index > 0) { // Skip first leg
              const legAwayInput = legCard.querySelector('.leg-away');
              const legHomeInput = legCard.querySelector('.leg-home');
              
              legAwayInput.value = sgpAwayTeam;
              legHomeInput.value = sgpHomeTeam;
            }
          });
        }
      }
    }

    function setupAutofill(legCard) {
      // Setup autofill for player/team inputs
      const inputs = legCard.querySelectorAll('input[data-autofill]');
      
      inputs.forEach(input => {
        const autofillType = input.getAttribute('data-autofill');
        let suggestions = [];
        
        // Get sport from the leg
        const sportSelect = legCard.querySelector('.leg-sport');
        
        function updateSuggestions() {
          const sport = sportSelect.value;
          if (autofillType === 'player') {
            suggestions = autofillData.players[sport] || [];
          } else if (autofillType === 'team') {
            suggestions = autofillData.teams[sport] || [];
          }
        }
        
        // Update suggestions when sport changes
        sportSelect.addEventListener('change', updateSuggestions);
        updateSuggestions(); // Initial update
        
        let currentFocus = -1;
        
        input.addEventListener('input', function() {
          const value = this.value.toLowerCase();
          closeAllLists();
          
          if (!value) return;
          
          currentFocus = -1;
          
          // Create a DIV element that will contain the items
          const listContainer = document.createElement('div');
          listContainer.setAttribute('id', this.id + '-autocomplete-list');
          listContainer.setAttribute('class', 'autocomplete-items');
          
          this.parentNode.appendChild(listContainer);
          
          // Filter suggestions
          const filtered = suggestions.filter(item => 
            item.toLowerCase().includes(value)
          ).slice(0, 5); // Limit to 5 suggestions
          
          filtered.forEach((suggestion, index) => {
            const item = document.createElement('div');
            item.innerHTML = suggestion;
            
            item.addEventListener('click', function() {
              input.value = suggestion;
              closeAllLists();
              
              // For SGP, update team values if this is a team input on first leg
              if (autofillType === 'team') {
                updateSGPTeams();
              }
            });
            
            listContainer.appendChild(item);
          });
        });
        
        input.addEventListener('keydown', function(e) {
          let list = document.getElementById(this.id + '-autocomplete-list');
          if (list) list = list.getElementsByTagName('div');
          
          if (e.keyCode === 40) { // Down arrow
            currentFocus++;
            addActive(list);
          } else if (e.keyCode === 38) { // Up arrow
            currentFocus--;
            addActive(list);
          } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (currentFocus > -1 && list) {
              list[currentFocus].click();
            }
          }
        });
        
        function addActive(list) {
          if (!list) return;
          removeActive(list);
          if (currentFocus >= list.length) currentFocus = 0;
          if (currentFocus < 0) currentFocus = list.length - 1;
          list[currentFocus].classList.add('autocomplete-active');
        }
        
        function removeActive(list) {
          for (let i = 0; i < list.length; i++) {
            list[i].classList.remove('autocomplete-active');
          }
        }
        
        function closeAllLists(element) {
          const items = document.getElementsByClassName('autocomplete-items');
          for (let i = 0; i < items.length; i++) {
            if (element !== items[i] && element !== input) {
              items[i].parentNode.removeChild(items[i]);
            }
          }
        }
        
        document.addEventListener('click', function(e) {
          closeAllLists(e.target);
        });
      });
    }

    function updateStatOptions(legId) {
      const legCard = document.getElementById(`leg-${legId}`);
      const sport = legCard.querySelector('.leg-sport').value;
      const category = legCard.querySelector('.leg-category').value;
      const statSelect = legCard.querySelector('.leg-stat');
      const playerLabel = legCard.querySelector('.leg-player-label');
      const playerInput = legCard.querySelector('.leg-player');
      
      // Update label based on category
      if (category === 'Team Props') {
        playerLabel.textContent = 'Team Name ';
        playerInput.placeholder = 'e.g., Kansas City Chiefs';
      } else {
        playerLabel.textContent = 'Player Name ';
        playerInput.placeholder = 'e.g., Patrick Mahomes';
      }
      playerLabel.innerHTML += '<span class="required">*</span>';
      
      // Clear and populate stat options
      statSelect.innerHTML = '<option value="">Select stat...</option>';
      
      if (sport && category && sportStats[sport] && sportStats[sport][category]) {
        sportStats[sport][category].forEach(stat => {
          const option = document.createElement('option');
          option.value = stat.value;
          option.textContent = stat.label;
          statSelect.appendChild(option);
        });
      }
    }

    function showNotification(message, type = 'success') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 3000);
    }

    async function submitBet(event) {
      event.preventDefault();
      
      // Collect bet data with all required fields matching OCR structure
      const betName = document.getElementById('bet-name').value.trim();
      const betData = {
        bet_id: document.getElementById('bet-id').value || `manual_${Date.now()}`,
        type: document.getElementById('bet-type').value,
        betting_site: document.getElementById('betting-site').value,
        bet_date: document.getElementById('bet-date').value,
        wager: parseFloat(document.getElementById('wager').value),
        potential_winnings: parseFloat(document.getElementById('potential-payout').value) || 0,
        final_odds: document.getElementById('odds').value,
        secondary_bettor_ids: selectedSecondaryBettors.map(b => b.id),
        sport: '', // Will be set from first leg
        status: 'pending',
        source: 'manual',
        legs: []
      };
      
      // Only include name if user provided one
      if (betName) {
        betData.name = betName;
      }

      // Collect legs
      const legCards = document.querySelectorAll('.leg-card');
      if (legCards.length === 0) {
        showNotification('Please add at least one leg to your bet', 'error');
        return;
      }

      legCards.forEach((legCard, index) => {
        const sport = legCard.querySelector('.leg-sport').value;
        if (index === 0) {
          betData.sport = sport;
        }
        
        const statValue = legCard.querySelector('.leg-stat').value;
        const statAdd = legCard.querySelector('.leg-stat-add').value;
        const awayTeam = legCard.querySelector('.leg-away').value;
        const homeTeam = legCard.querySelector('.leg-home').value;
        
        // Map to database structure
        const leg = {
          game_date: legCard.querySelector('.leg-date').value,
          away_team: awayTeam,
          home_team: homeTeam,
          team: homeTeam, // Default to home team for player_team
          player: legCard.querySelector('.leg-player').value,
          stat: statValue,
          bet_type: statValue.includes('moneyline') || statValue.includes('spread') || statValue.includes('total') ? statValue : 'player_prop',
          bet_line_type: statAdd, // 'over' or 'under'
          line: statValue === 'moneyline' ? 0 : parseFloat(legCard.querySelector('.leg-target').value), // Moneyline target is always 0
          sport: sport,
          game_info: `${awayTeam} @ ${homeTeam}`,
          odds: '-110', // Default odds for manual entry legs
          status: 'pending',
          leg_order: index
        };
        
        betData.legs.push(leg);
      });

      // Calculate bet date (earliest game date)
      const dates = betData.legs.map(leg => leg.game_date);
      betData.bet_date = dates.sort()[0];

      try {
        const response = await fetch('/api/bets', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify(betData)
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.error || 'Failed to create bet');
        }

        const result = await response.json();
        showNotification('Bet created successfully! Redirecting...', 'success');
        
        setTimeout(() => {
          window.location.href = '/';
        }, 1500);
        
      } catch (error) {
        console.error('Error creating bet:', error);
        showNotification(error.message, 'error');
      }
    }

    // Initialize
    document.getElementById('add-leg-btn').addEventListener('click', addLeg);
    document.getElementById('add-bet-form').addEventListener('submit', submitBet);
    
    // Add first leg by default
    addLeg();
  </script>
  
  <!-- Bottom Navigation Bar -->
  <nav class="bottom-nav">
    <a href="/" class="bottom-nav-item" data-action="my-bets">
      <span class="nav-icon">üìä</span>
      <span class="nav-label">My Bets</span>
    </a>
    <a href="/explore" class="bottom-nav-item" data-action="explore">
      <span class="nav-icon">üîç</span>
      <span class="nav-label">Explore</span>
    </a>
    <a href="/watched" class="bottom-nav-item" data-action="watched">
      <span class="nav-icon">‚≠ê</span>
      <span class="nav-label">Watched</span>
    </a>
    <a href="/social" class="bottom-nav-item" data-action="social">
      <span class="nav-icon">üë•</span>
      <span class="nav-label">Social</span>
    </a>
    <a href="/account" class="bottom-nav-item" data-action="account">
      <span class="nav-icon">üë§</span>
      <span class="nav-label">Account</span>
    </a>
  </nav>
  
  <script src="bottom-nav.js"></script>
</body>
</html>
